<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>PassKey Overlay</title>
  <link rel="stylesheet" href="overlay.css" />
</head>

<body>
  <div id="container">
    <div class="card">
      <div class="header">
        <img src="/passkey_wallet.svg" alt="Logo" class="logo">
        <div class="title-group">
          <div class="domain" id="domain">Detecting...</div>
          <div class="app-name" id="appName">...</div>
        </div>
        <button class="close-btn" id="btnClose">Ã—</button>
      </div>

      <div id="content">
        <!-- Credentials will be injected here -->
      </div>
      <div class="footer-hints"
        style="margin-top: auto; padding-top: 10px; border-top: 1px solid #333; font-size: 0.75rem; color: #666; display: flex; justify-content: space-between;">
        <span>Click to Copy</span>
        <span>Esc to Close</span>
      </div>
    </div>
  </div>

  <script>
    const domainEl = document.getElementById('domain')
    const appNameEl = document.getElementById('appName')
    const contentEl = document.getElementById('content')
    const btnClose = document.getElementById('btnClose')

    btnClose.onclick = () => window.api.hideOverlay()

    window.api.onShowCredentials((data) => {
      domainEl.textContent = data.site
      appNameEl.textContent = data.appName ? `via ${data.appName}` : ''

      contentEl.innerHTML = '' // Clear previous content

      // Check if new format (credentials array)
      if (data.credentials) {
        handleNewFormat(data.credentials);
      } else if (data.username) {
        // Legacy format - single credential
        handleSingleCredential({ username: data.username, password: data.password });
      } else {
        showNoCredentials();
      }
    })

    function handleNewFormat(credentials) {
      if (!credentials || credentials.length === 0) {
        showNoCredentials();
        return;
      }

      if (credentials.length === 1) {
        handleSingleCredential(credentials[0]);
      } else {
        handleMultipleCredentials(credentials);
      }
    }

    function showNoCredentials() {
      contentEl.innerHTML = '<div class="row"><span class="value" style="color: #666; font-style: italic;">No details found</span></div>';
    }

    function handleSingleCredential(cred) {
      // User Row
      const userRow = document.createElement('div');
      userRow.className = 'row';
      userRow.innerHTML = `
        <span class="label">User:</span>
        <span class="value clickable">${escapeHtml(cred.username)}</span>
      `;
      userRow.querySelector('.value').onclick = () => {
        window.api.copyToClipboard(cred.username);
        showCopyNotification('Username copied!');
      };
      contentEl.appendChild(userRow);

      // Pass Row - Copy without showing
      const passRow = document.createElement('div');
      passRow.className = 'row';
      passRow.innerHTML = `
        <span class="label">Pass:</span>
        <button class="copy-pass-btn">ðŸ“‹ Copy Password</button>
      `;
      const copyBtn = passRow.querySelector('.copy-pass-btn');
      copyBtn.onclick = () => {
        window.api.copyToClipboard(cred.password);
        copyBtn.textContent = 'âœ“ Copied!';
        copyBtn.style.background = '#28a745';
        setTimeout(() => window.api.hideOverlay(), 1000);
      };
      contentEl.appendChild(passRow);
    }

    function handleMultipleCredentials(credentials) {
      const header = document.createElement('div');
      header.className = 'multi-header';
      header.innerHTML = '<strong>Select Account:</strong>';
      contentEl.appendChild(header);

      credentials.forEach((cred, index) => {
        const credDiv = document.createElement('div');
        credDiv.className = 'credential-item';
        credDiv.innerHTML = `
          <div class="username-row">
            <span class="username-text">${escapeHtml(cred.username)}</span>
            <div class="actions">
              <button class="copy-btn-small" data-type="username">ðŸ“‹ User</button>
              <button class="copy-btn-small" data-type="password">ðŸ“‹ Pass</button>
            </div>
          </div>
        `;

        // Add event listeners
        const buttons = credDiv.querySelectorAll('.copy-btn-small');
        buttons.forEach(btn => {
          btn.onclick = (e) => {
            e.stopPropagation();
            const type = btn.dataset.type;
            const text = type === 'username' ? cred.username : cred.password;
            window.api.copyToClipboard(text);
            btn.textContent = 'âœ“';
            btn.style.background = '#28a745';
            setTimeout(() => {
              if (type === 'password') {
                window.api.hideOverlay();
              }
            }, type === 'password' ? 800 : 0);
          };
        });

        contentEl.appendChild(credDiv);
      });
    }

    function showCopyNotification(msg) {
      console.log(msg);
    }

    function escapeHtml(text) {
      const div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML;
    }

    // Close on Esc
    window.addEventListener('keydown', (e) => {
      if (e.key === 'Escape') {
        window.api.hideOverlay()
      }
    })
  </script>
</body>

</html>