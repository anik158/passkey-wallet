<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PassKey Wallet Dashboard</title>
    <style>
        :root {
            --bg-color: #121212;
            --card-bg: #1e1e1e;
            --input-bg: #2c2c2c;
            --text-main: #ffffff;
            --text-muted: #aaaaaa;
            --accent-color: #444444;
            --accent-hover: #555555;
            --border-color: #333333;
            --danger-color: #e57373;
        }

        body {
            font-family: 'Inter', system-ui, -apple-system, sans-serif;
            margin: 0;
            padding: 20px;
            background-color: var(--bg-color);
            color: var(--text-main);
            height: 100vh;
            box-sizing: border-box;
            overflow-x: hidden;
            /* Prevent horizontal scroll */
            overflow-y: auto;
            /* Allow vertical scroll if needed */
        }

        .container {
            max-width: 1000px;
            margin: 0 auto;
            background: var(--card-bg);
            border-radius: 8px;
            padding: 2rem;
            border: 1px solid var(--border-color);
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.3);
            min-height: 80vh;
            display: flex;
            flex-direction: column;
        }

        header {
            display: flex;
            align-items: center;
            gap: 1.5rem;
            margin-bottom: 2rem;
            border-bottom: 1px solid var(--border-color);
            padding-bottom: 1rem;
        }

        .logo {
            width: 40px;
            height: 40px;
            filter: drop-shadow(0 0 2px rgba(255, 255, 255, 0.2));
        }

        h1 {
            margin: 0;
            font-size: 1.5rem;
            color: var(--text-main);
            font-weight: 600;
        }

        .actions {
            display: flex;
            gap: 12px;
            margin-bottom: 20px;
            flex-wrap: wrap;
            align-items: center;
        }

        button {
            padding: 10px 18px;
            background-color: var(--input-bg);
            color: var(--text-main);
            border: 1px solid var(--border-color);
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.2s;
            font-weight: 500;
            font-size: 0.9rem;
        }

        button:hover {
            border-color: #666;
            background-color: #383838;
        }

        button.primary {
            background-color: var(--text-main);
            color: var(--bg-color);
            border-color: var(--text-main);
            font-weight: 600;
        }

        button.primary:hover {
            background-color: #e0e0e0;
            border-color: #e0e0e0;
        }

        .import-hint {
            font-size: 0.8rem;
            color: var(--text-muted);
            margin-left: 0.5rem;
            font-style: italic;
        }

        /* Responsive Table */
        .table-responsive {
            width: 100%;
            overflow-x: auto;
            -webkit-overflow-scrolling: touch;
            margin-bottom: 1rem;
            border-radius: 6px;
            border: 1px solid var(--border-color);
        }

        table {
            width: 100%;
            border-collapse: collapse;
            /* margin-bottom from wrapper now */
            min-width: 600px;
            /* Ensure table doesn't squish too much */
        }

        th,
        td {
            text-align: left;
            padding: 14px;
            border-bottom: 1px solid var(--border-color);
        }

        th {
            color: var(--text-muted);
            font-weight: 600;
            font-size: 0.85rem;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            background-color: rgba(255, 255, 255, 0.02);
        }

        tr:last-child td {
            border-bottom: none;
        }

        tr:hover {
            background-color: rgba(255, 255, 255, 0.03);
        }

        .masked-pass {
            font-family: monospace;
            color: var(--text-muted);
            letter-spacing: 2px;
        }

        .action-cell {
            display: flex;
            gap: 8px;
        }

        button.btn-sm {
            padding: 6px 12px;
            font-size: 0.85rem;
        }

        button.btn-danger {
            color: var(--danger-color);
            border-color: var(--border-color);
        }

        button.btn-danger:hover {
            border-color: var(--danger-color);
            background: rgba(229, 115, 115, 0.1);
        }

        .pagination {
            margin-top: auto;
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding-top: 20px;
            border-top: 1px solid var(--border-color);
        }

        #pageInfo {
            color: var(--text-muted);
            font-variant-numeric: tabular-nums;
        }

        /* Modal Styles */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.85);
            justify-content: center;
            align-items: center;
            z-index: 100;
        }

        .modal.active {
            display: flex;
        }

        .modal-content {
            background: var(--card-bg);
            padding: 2rem;
            border-radius: 8px;
            width: 400px;
            border: 1px solid var(--border-color);
            box-shadow: 0 20px 50px rgba(0, 0, 0, 0.5);
        }

        form {
            display: flex;
            flex-direction: column;
            gap: 1rem;
            text-align: left;
        }

        label {
            font-size: 0.9rem;
            color: var(--text-muted);
            margin-bottom: 0.4rem;
            display: block;
        }

        input {
            width: 100%;
            padding: 12px;
            background: var(--input-bg);
            border: 1px solid var(--border-color);
            color: white;
            border-radius: 6px;
            box-sizing: border-box;
            font-size: 1rem;
        }

        input:focus {
            outline: none;
            border-color: #888;
        }

        /* Password Toggle Styles */
        .input-group {
            position: relative;
            display: flex;
            align-items: center;
        }

        .input-group input {
            padding-right: 40px;
            /* Space for eye icon */
        }

        .toggle-password {
            background: none;
            border: none;
            color: var(--text-muted);
            position: absolute;
            right: 5px;
            top: 50%;
            transform: translateY(-50%);
            cursor: pointer;
            font-size: 1.1rem;
            padding: 4px;
            border-radius: 4px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .toggle-password:hover {
            color: white;
            background: none;
            border-color: transparent;
        }

        /* Mobile Responsive */
        @media (max-width: 768px) {
            body {
                padding: 10px;
            }

            .container {
                padding: 1.25rem;
                min-height: auto;
            }

            header {
                flex-direction: column;
                align-items: flex-start;
                gap: 1rem;
            }

            .actions {
                flex-direction: column;
                align-items: stretch;
            }

            .actions>span {
                display: none;
                /* Hide spacer */
            }

            button {
                width: 100%;
            }

            /* Adjust imports row */
            .actions>div {
                flex-direction: column;
                width: 100%;
                align-items: stretch !important;
            }

            .import-hint {
                text-align: center;
                margin: 5px 0 10px 0;
            }
        }
    </style>
</head>

<body>
    <div class="container">
        <header>
            <img src="/passkey_wallet.svg" alt="App Logo" class="logo">
            <h1>Passkey Wallet</h1>
        </header>

        <div class="actions">
            <button class="primary" id="btnAdd">+ Add Password</button>
            <div style="display: flex; align-items: center; gap: 8px; flex-wrap: wrap;">
                <button id="btnImport" title="(Expected cols: Domain, User, Pass)">Import Excel</button>
            </div>

            <span style="flex-grow:1"></span>

            <div style="display: flex; gap: 8px;">
                <button id="btnSettings" title="App Settings">Settings</button>
                <button id="btnLock" class="btn-danger" title="Lock App Now">Lock üîí</button>
                <button id="btnHelp" title="User Check Manual">Help ‚ùì</button>
            </div>

            <button id="btnBackup" title="Export secure backup">Backup .qpass</button>
            <button id="btnRestore" title="Restore from secure backup">Restore .qpass</button>
        </div>

        <!-- ... table ... -->

        <!-- Settings Modal -->
        <div id="settingsModal" class="modal">
            <div class="modal-content">
                <h2>Settings</h2>
                <form id="settingsForm">
                    <label>Auto-Lock Duration (minutes)</label>
                    <input type="number" id="inpAutoLock" min="1" max="1440" required>
                    <small style="color: #666; display:block; margin-top:4px;">App will lock after system is idle for
                        this long.</small>

                    <div style="display: flex; justify-content: flex-end; gap: 10px; margin-top: 1rem;">
                        <button type="button" id="btnSettingsCancel">Cancel</button>
                        <button type="submit" class="primary">Save</button>
                    </div>
                </form>
            </div>
        </div>


        <div class="table-responsive">
            <table>
                <thead>
                    <tr>
                        <th>Domain</th>
                        <th>Username</th>
                        <th>Password</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody id="tableBody">
                    <!-- Rows will be injected here -->
                </tbody>
            </table>
        </div>

        <div class="pagination">
            <button id="btnPrev" disabled>‚Üê Previous</button>
            <span id="pageInfo">Page 1</span>
            <button id="btnNext" disabled>Next ‚Üí</button>
        </div>
    </div>

    <!-- Add/Edit Modal -->
    <div id="modal" class="modal">
        <div class="modal-content">
            <h2 id="modalTitle">Add Credential</h2>
            <form id="credForm">
                <input type="hidden" id="editId">

                <label>Domain (e.g., github.com)</label>
                <input type="text" id="inpDomain" required placeholder="github.com">

                <label>Username</label>
                <input type="text" id="inpUser" required placeholder="me@email.com">

                <label>Password</label>
                <div class="input-group">
                    <input type="password" id="inpPass" required placeholder="Secret123!">
                    <button type="button" class="toggle-password" data-target="inpPass" tabindex="-1">üëÅÔ∏è</button>
                </div>

                <div style="display: flex; justify-content: flex-end; gap: 10px; margin-top: 1rem;">
                    <button type="button" id="btnCancel">Cancel</button>
                    <button type="submit" class="primary">Save</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Help Modal -->
    <div id="helpModal" class="modal">
        <div class="modal-content" style="max-width: 600px;">
            <h2>User Manual Passkey Wallet</h2>
            <div style="overflow-y: auto; max-height: 400px; line-height: 1.6;">
                <h3>Navigation & Buttons</h3>
                <ul>
                    <li><b>Add Credential:</b> Create a new password entry manually.</li>
                    <li><b>Import Excel:</b> Load passwords from a CSV/XLSX file. Columns should be: <i>Domain,
                            Username, Password</i>.</li>
                    <li><b>Backup .qpass:</b> Export your entire vault to an encrypted file. You assume a password for
                        this file.</li>
                    <li><b>Restore .qpass:</b> Load a previously backed-up .qpass file. Requires the password you set.
                    </li>
                    <li><b>Lock:</b> Immediately closes the database and clears memory. Use this when stepping away.
                    </li>
                </ul>

                <h3>Security Features</h3>
                <ul>
                    <li><b>Auto-Lock:</b> The app locks itself after 60 minutes (default) of inactivity.</li>
                    <li><b>Overlay (Ctrl+Alt+P):</b> Press this global shortcut to find passwords. Click on the
                        <b>User</b> or <b>Pass</b> to copy them to your clipboard.</li>
                    <li><b>Clipboard:</b> Passwords are copied to clipboard. Be careful to paste them only where
                        intended.</li>
                </ul>
            </div>
            <div style="display: flex; justify-content: flex-end; margin-top: 1rem;">
                <button type="button" id="btnHelpClose" class="primary">Close</button>
            </div>
        </div>
    </div>

    <!-- Password Prompt Modal -->
    <div id="passModal" class="modal">
        <div class="modal-content" style="width: 300px;">
            <h2 id="passModalTitle">Enter Password</h2>
            <p id="passModalDesc" style="color: var(--text-muted); font-size: 0.9rem; margin-bottom: 1rem;">Enter
                encryption password for backup:</p>
            <form id="passForm">
                <div class="input-group">
                    <input type="password" id="backupPassword" required placeholder="Encryption Password" autofocus>
                    <button type="button" class="toggle-password" data-target="backupPassword"
                        tabindex="-1">üëÅÔ∏è</button>
                </div>
                <div style="display: flex; justify-content: flex-end; gap: 10px; margin-top: 1rem;">
                    <button type="button" id="btnPassCancel">Cancel</button>
                    <button type="submit" class="primary">Confirm</button>
                </div>
            </form>
        </div>
    </div>

    <script>
        console.log('Dashboard script loaded!');

        // Helper to secure the view against XSS (basic)
        const escapeHtml = (str) => {
            if (!str) return '';
            return str.replace(/&/g, "&amp;")
                .replace(/</g, "&lt;")
                .replace(/>/g, "&gt;")
                .replace(/"/g, "&quot;")
                .replace(/'/g, "&#039;");
        }

        const tableBody = document.getElementById('tableBody');
        const modal = document.getElementById('modal');
        const form = document.getElementById('credForm');

        // Pager Elements
        const btnPrev = document.getElementById('btnPrev');
        const btnNext = document.getElementById('btnNext');
        const pageInfo = document.getElementById('pageInfo');

        // State
        let isEditing = false;
        let currentPage = 1;
        const PAGE_SIZE = 10;
        let totalItems = 0;

        // Initialize
        async function loadCredentials() {
            try {
                // Fetch valid page
                const { data, total } = await window.api.getCredentialsPage(currentPage, PAGE_SIZE);
                totalItems = total;

                // If page > 1 but no data (e.g. deleted last item), go back
                if (data.length === 0 && currentPage > 1) {
                    currentPage--;
                    loadCredentials();
                    return;
                }

                renderTable(data);
                updatePagination();
            } catch (err) {
                console.error('Failed to load credentials:', err);
            }
        }

        function updatePagination() {
            const totalPages = Math.ceil(totalItems / PAGE_SIZE) || 1;
            pageInfo.textContent = `Page ${currentPage} of ${totalPages}`;

            btnPrev.disabled = currentPage <= 1;
            btnNext.disabled = currentPage >= totalPages;
        }

        btnPrev.onclick = () => {
            if (currentPage > 1) {
                currentPage--;
                loadCredentials();
            }
        };

        btnNext.onclick = () => {
            const totalPages = Math.ceil(totalItems / PAGE_SIZE);
            if (currentPage < totalPages) {
                currentPage++;
                loadCredentials();
            }
        };

        function renderTable(creds) {
            tableBody.innerHTML = '';

            if (creds.length === 0) {
                tableBody.innerHTML = '<tr><td colspan="4" style="text-align:center; color:#888;">No passwords saved yet.</td></tr>';
                return;
            }

            creds.forEach(cred => {
                const tr = document.createElement('tr');
                tr.innerHTML = `
                <td>${escapeHtml(cred.domain)}</td>
                <td>${escapeHtml(cred.username)}</td>
                <td class="masked-pass" title="Hover to reveal">‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢</td>
                <td class="action-cell">
                    <button class="btn-copy btn-sm" data-pass="${escapeHtml(cred.password)}">Copy</button>
                    <button class="btn-edit btn-sm" data-id="${cred.id}" data-domain="${escapeHtml(cred.domain)}" data-user="${escapeHtml(cred.username)}" data-pass="${escapeHtml(cred.password)}">Edit</button>
                    <button class="btn-delete btn-sm btn-danger" data-id="${cred.id}">Delete</button>
                </td>
            `;

                // Setup listeners for this row
                const copyBtn = tr.querySelector('.btn-copy');
                copyBtn.onclick = () => window.api.copyToClipboard(copyBtn.dataset.pass);

                const editBtn = tr.querySelector('.btn-edit');
                editBtn.onclick = () => {
                    isEditing = true;
                    document.getElementById('modalTitle').textContent = 'Edit Credential';
                    document.getElementById('editId').value = editBtn.dataset.id;
                    document.getElementById('inpDomain').value = editBtn.dataset.domain;
                    document.getElementById('inpDomain').disabled = true; // Domain is primary key-ish for now
                    document.getElementById('inpUser').value = editBtn.dataset.user;
                    document.getElementById('inpPass').value = editBtn.dataset.pass;
                    modal.classList.add('active');
                };

                const delBtn = tr.querySelector('.btn-delete');
                delBtn.onclick = async () => {
                    if (confirm(`Delete password for ${cred.domain}?`)) {
                        await window.api.deleteCredential(cred.id);
                        loadCredentials();
                    }
                };

                tableBody.appendChild(tr);
            });
        }

        // Event Listeners
        // Check if element exists before attaching to avoid errors if ID changed
        const btnRefresh = document.getElementById('btnRefresh');
        if (btnRefresh) btnRefresh.onclick = loadCredentials;

        document.getElementById('btnAdd').onclick = () => {
            console.log('Add clicked');
            isEditing = false;
            document.getElementById('modalTitle').textContent = 'Add Credential';
            form.reset();
            document.getElementById('editId').value = '';
            document.getElementById('inpDomain').disabled = false;
            modal.classList.add('active');
        };

        document.getElementById('btnCancel').onclick = () => {
            modal.classList.remove('active');
        };

        form.onsubmit = async (e) => {
            e.preventDefault();
            console.log('Submitting form');

            const id = document.getElementById('editId').value;
            const data = {
                id: id ? parseInt(id) : null,
                domain: document.getElementById('inpDomain').value,
                username: document.getElementById('inpUser').value,
                password: document.getElementById('inpPass').value
            };

            if (isEditing) {
                await window.api.updateCredential(data);
            } else {
                await window.api.addCredential(data);
            }

            console.log('Saved');

            modal.classList.remove('active');
            loadCredentials();
        };

        document.getElementById('btnImport').onclick = async () => {
            // Using logic from main, which returns detailed stats
            const res = await window.api.importFromExcel();
            if (res.success) {
                let msg = `Imported ${res.count} passwords!`;
                if (res.skipped > 0) msg += ` (Skipped ${res.skipped} invalid rows)`;
                alert(msg);
                currentPage = 1; // Go to first page to see new items
                loadCredentials();
            } else if (!res.cancelled) {
                alert('Import failed: ' + res.message);
            }
        };

        // Export button removed

        // Password Prompt Helper
        function requestPassword(title, desc) {
            return new Promise((resolve) => {
                const passModal = document.getElementById('passModal');
                const passForm = document.getElementById('passForm');
                const passInput = document.getElementById('backupPassword');

                document.getElementById('passModalTitle').textContent = title;
                document.getElementById('passModalDesc').textContent = desc || '';
                passInput.value = '';

                passModal.classList.add('active');
                passInput.focus();

                const close = (val) => {
                    passModal.classList.remove('active');
                    resolve(val);
                    // Cleanup listeners to avoid dupes if reused? 
                    // Simpler: Just override onclicks every time since we return a new promise
                };

                document.getElementById('btnPassCancel').onclick = () => close(null);

                passForm.onsubmit = (e) => {
                    e.preventDefault();
                    close(passInput.value);
                };
            });
        }

        document.getElementById('btnBackup').onclick = async () => {
            const password = await requestPassword('Backup Password', 'Set a password to encrypt this backup file:');
            if (!password) return;

            const res = await window.api.exportEncrypted(password);
            if (res.success) alert('Backup saved successfully!');
            else if (!res.cancelled) alert('Backup failed: ' + res.message);
        };

        document.getElementById('btnRestore').onclick = async () => {
            // 1. Select File
            const filePath = await window.api.selectBackupFile();
            if (!filePath) return; // User cancelled

            // 2. Ask for Password
            const password = await requestPassword(
                'Unlock Backup',
                `Enter password to decrypt: ${filePath.split(/[/\\]/).pop()}`
            );

            if (!password) return;

            if (!confirm('This will import passwords from the backup. Continue?')) return;

            // 3. Restore
            const res = await window.api.restoreBackup(filePath, password);
            if (res.success) {
                alert(`Restored ${res.count} passwords!`);
                loadCredentials();
            } else {
                alert('Restore failed: ' + res.message);
            }
        };

        // Password Toggle Logic
        document.querySelectorAll('.toggle-password').forEach(btn => {
            btn.onclick = () => {
                const targetId = btn.dataset.target;
                const input = document.getElementById(targetId);
                if (input.type === 'password') {
                    input.type = 'text';
                    // Optional: Change icon to slash-eye if you had SVGs
                } else {
                    input.type = 'password';
                }
            };
        });

        // ... existing logic ...

        // Settings Logic
        const settingsModal = document.getElementById('settingsModal');
        const inpAutoLock = document.getElementById('inpAutoLock');

        document.getElementById('btnSettings').onclick = async () => {
            try {
                const settings = await window.api.getSettings();
                inpAutoLock.value = settings.autoLockMinutes || 60;
                settingsModal.classList.add('active');
            } catch (err) {
                console.error(err);
                alert('Error loading settings: ' + err.message);
            }
        };

        document.getElementById('btnSettingsCancel').onclick = () => {
            settingsModal.classList.remove('active');
        };

        document.getElementById('settingsForm').onsubmit = async (e) => {
            e.preventDefault();
            await window.api.saveSettings({
                autoLockMinutes: inpAutoLock.value
            });
            settingsModal.classList.remove('active');
            alert('Settings saved!');
        };

        // Lock Logic
        document.getElementById('btnLock').onclick = async () => {
            if (confirm('Lock the application now?')) {
                await window.api.lockApp();
            }
        };

        // Help Modal Logic
        const btnHelp = document.getElementById('btnHelp');
        const helpModal = document.getElementById('helpModal');
        const btnHelpClose = document.getElementById('btnHelpClose');

        if (btnHelp) {
            btnHelp.onclick = () => {
                helpModal.classList.add('active');
            }
        }
        if (btnHelpClose) {
            btnHelpClose.onclick = () => {
                helpModal.classList.remove('active');
            }
        }

        // Start
        loadCredentials();
    </script>
</body>

</html>